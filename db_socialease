CREATE SCHEMA production;

CREATE TABLE production.platforms (
    platform_id SMALLINT PRIMARY KEY,
    description VARCHAR(50) NOT NULL
);

CREATE TABLE production.states (
    state_id SMALLINT PRIMARY KEY,
    description VARCHAR(50) NOT NULL
);

CREATE TABLE production.roles (
    role_id SMALLINT PRIMARY KEY,
    description VARCHAR(50) NOT NULL,
    active BOOLEAN NOT NULL
);

CREATE TABLE production.users (
    user_id INTEGER PRIMARY KEY,
    username VARCHAR(75) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    active BOOLEAN NOT NULL,
    role_id SMALLINT NOT NULL,
    last_login TIMESTAMP,
    created_at TIMESTAMP,
    CONSTRAINT fk_role_id FOREIGN KEY (role_id) REFERENCES production.roles (role_id)
);

CREATE TABLE production.posts (
    post_id BIGINT PRIMARY KEY,
    user_id INTEGER NOT NULL,
    content TEXT NOT NULL,
    scheduled_at TIMESTAMP NOT NULL,
    state_id SMALLINT NOT NULL,
    created_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES production.users (user_id),
    CONSTRAINT fk_state_id FOREIGN KEY (state_id) REFERENCES production.states (state_id)
);

CREATE TABLE production.social_accounts (
    social_account_id BIGINT PRIMARY KEY,
    user_id INTEGER NOT NULL,
    platform_id SMALLINT NOT NULL,
    access_token VARCHAR(255) NOT NULL,
    account_name VARCHAR(255) NOT NULL,
    account_id VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES production.users (user_id),
    CONSTRAINT fk_platform_id FOREIGN KEY (platform_id) REFERENCES production.platforms (platform_id)
);

CREATE TABLE production.post_social_accounts (
    post_id BIGINT NOT NULL,
    social_account_id BIGINT NOT NULL,
    published_at TIMESTAMP,
    PRIMARY KEY (post_id, social_account_id)
);

CREATE TABLE production.post_metrics (
    post_metric_id BIGINT PRIMARY KEY,
    post_id BIGINT NOT NULL,
    social_account_id BIGINT NOT NULL,
    likes INTEGER NOT NULL,
    shares INTEGER NOT NULL,
    comments INTEGER NOT NULL,
    impressions INTEGER NOT NULL,
    collected_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_post_social_account_id FOREIGN KEY (post_id, social_account_id) REFERENCES production.post_social_accounts (post_id, social_account_id)
);

CREATE TABLE production.post_logs (
    post_log_id BIGINT PRIMARY KEY,
    post_id BIGINT NOT NULL,
    social_account_id BIGINT NOT NULL,
    state_id SMALLINT NOT NULL,
    error_message TEXT,
    logged_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_post_social_account_id FOREIGN KEY (post_id, social_account_id) REFERENCES production.post_social_accounts (post_id, social_account_id),
    CONSTRAINT fk_state_id FOREIGN KEY (state_id) REFERENCES production.states (state_id)
);
